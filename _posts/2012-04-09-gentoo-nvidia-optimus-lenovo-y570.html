---
layout: post
title: Gentoo и Nvidia OPTIMUS на Lenovo Y570
date: '2012-04-09T00:51:00.003+04:00'
author: Дмитрий К
tags:
- nvidia
- optimus
- intel
- lenovo y570
- gentoo
modified_time: '2012-07-26T12:58:45.937+04:00'
blogger_id: tag:blogger.com,1999:blog-3722882267608887154.post-1562250077660300398
blogger_orig_url: http://ubufang.blogspot.com/2012/04/gentoo-nvidia-optimus-lenovo-y570.html
---

Не так давно на рынке ноутбуков появились две технологии которые ввели в недоумение как разработчиков так и пользователей операционных систем базирующихся на ядре Linux, имя этим технологиям: Nvidia OPTIMUS и&nbsp;AMD Dynamic Switchable Graphics. У второй все сложилось более менее хорошо, т.к. AMD практически сразу добавили поддержку фичи в свой проприоритарный драйвер,а так же достойная поддержка&nbsp;<a href="https://help.ubuntu.com/community/HybridGraphics#Enabling_vga_switcheroo">vga_switcherro</a>, а вот драйвер от Nvidia под linux до сих пор не подразумевает о существовании двух видео адаптеров в системе.<br />Конечно же коммьюнити не оставило пользователей в беде, именно благодаря проекту <a href="https://github.com/Bumblebee-Project/Bumblebee">Bumblebee</a>, большинство ноутбуков с гибридной графикой, где один из видео-адаптеров Nvidia, полноценно работают под Linux.<br />Но не все так гладко как хотелось бы, дело в том, что Bumblebee переключит только ту карточку которую он "знает", отсюда возникла проблема и<a href="https://github.com/Bumblebee-Project/bbswitch/tree/hack-lenovo"> вынужденный хак</a> для Lenovo Y470/Y570, так как их конфигурация железа оказалась не стандартной. По приведенной ссылке располагается инструкция по устанновке на Ubuntu, для Gentoo все выглядит несколько иначе.<br />Итак, что бы собрать хак(который ядерный модуль) на Gentoo, необходимо:<br /><br /><ol><li>Подключить, с помощью layman, оверлей sabayon: <span style="font-family: 'Courier New', Courier, monospace;">sudo layman -a sabayon</span></li><li>Установить dkms: <span style="font-family: 'Courier New', Courier, monospace;">emerge --sync &amp;&amp; emerge -av dkms&nbsp;</span></li><li>Получить исходные коды модуля и собрать его:</li></ol><blockquote class="tr_bq"><pre style="background-color: #f8f8f8; border-bottom-color: rgb(204, 204, 204); border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: solid; border-bottom-width: 1px; border-color: initial; border-image: initial; border-left-color: rgb(204, 204, 204); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(204, 204, 204); border-right-style: solid; border-right-width: 1px; border-style: initial; border-top-color: rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: solid; border-top-width: 1px; color: #333333; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: 19px; margin-bottom: 15px; margin-top: 15px; overflow-x: auto; overflow-y: auto; padding-bottom: 6px; padding-left: 10px; padding-right: 10px; padding-top: 6px;"><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;">$ git clone git://github.com/Bumblebee-Project/bbswitch.git -b hack-lenovo<br />$ cd bbswitch<br />$ mkdir /usr/src/acpi-handle-hack-0.0.1<br /># cp Makefile acpi-handle-hack.c /usr/src/acpi-handle-hack-0.0.1<br /># cp dkms/acpi-handle-hack.conf /usr/src/acpi-handle-hack-0.0.1/dkms.conf<br /># dkms add -m acpi-handle-hack -v 0.0.1<br /># dkms build -m  acpi-handle-hack -v 0.0.1<br /># dkms install -m acpi-handle-hack -v 0.0.1</code></pre></blockquote><br />&nbsp; &nbsp; 4. Посмотреть куда собрался модуль и переименовать его с вида acpi-handle-hack.ko в&nbsp;acpi_handle_hack.ko<br /><div>&nbsp; &nbsp; 5. Загрузить модуль и проверить, что все работает командой optirun glxspheres.Следует отметить, что bumblebee работает через virtualgl, что крайне отрицательно сказывается на производительности, в данный момент ведутся работы по доработке virtualgl или же поиску альтернатив.<br />&nbsp; &nbsp; 6. Выполнить команду <i>depmod</i> с правами root.<br />&nbsp; &nbsp; 7. Добавить модуль в автозагрузку <br /><div><span style="background-color: white;"><br /></span></div><span style="background-color: white;"><div><div>Так же, для ноутбуков со встроенной графикой Intel-i915, для повышения энергосбережения, в опции ядра(grub.cfg) можно добавить:</div><blockquote class="tr_bq"><pre style="background-color: #f8f8f8; border-bottom-color: rgb(204, 204, 204); border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: solid; border-bottom-width: 1px; border-color: initial; border-image: initial; border-left-color: rgb(204, 204, 204); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(204, 204, 204); border-right-style: solid; border-right-width: 1px; border-style: initial; border-top-color: rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: solid; border-top-width: 1px; color: #333333; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: 19px; margin-bottom: 15px; margin-top: 15px; overflow-x: auto; overflow-y: auto; padding-bottom: 6px; padding-left: 10px; padding-right: 10px; padding-top: 6px;"><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;">i915.modeset=1 i915.i915_enable_rc6=1 i915.i915_enable_fbc=1 i915.lvds_downclock=1 pcie_aspm=force acpi_pme=native</code></pre></blockquote><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code><br /><div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;">Вот и все:) dkms можно удалить и отключить оверлей sabayon, т.к. до следующего обновления ядра эту операцию проделывать не придется.&nbsp;</code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code><br /><div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><br /></code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code><br /><div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><br /></code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code><br /><div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><br /></code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code><br /><div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;">Отдельное спасибо проекту <a href="http://linux-hybrid-graphics.blogspot.com/">Linux Hybrid Graphics</a>&nbsp;за безвозмездный труд.</code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code><br /><div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><br /></code><br /><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><br /></code><br /><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><br /></code></div><code style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; border-bottom-style: none; border-color: initial; border-image: initial; border-left-style: none; border-right-style: none; border-style: initial; border-top-left-radius: 3px; border-top-right-radius: 3px; border-top-style: none; border-width: initial; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; font: inherit; line-height: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"></code></span></div>